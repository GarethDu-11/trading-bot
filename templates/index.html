<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .tabs { 
            display: flex; 
            background-color: #f1f1f1; 
            border-radius: 20px; 
            overflow: hidden; 
            width: fit-content; 
        }
        .tab-button { 
            background-color: #f1f1f1; 
            border: none; 
            padding: 10px 20px; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .tab-button:first-child { border-radius: 20px 0 0 20px; }
        .tab-button:last-child { border-radius: 0 20px 20px 0; }
        .tab-button.active { 
            color: #00b7eb; 
            font-weight: bold; 
            background-color: #e0e0e0; 
        }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .sub-tabs { 
            display: flex; 
            background-color: #ddd; 
            border-radius: 15px; 
            width: fit-content; 
            margin-bottom: 10px; 
        }
        .sub-tab-item { 
            background-color: #ddd; 
            border: none; 
            padding: 5px 15px; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .sub-tab-item:first-child { border-radius: 15px 0 0 15px; }
        .sub-tab-item:last-child { border-radius: 0 15px 15px 0; }
        .sub-tab-item.active { 
            color: #00b7eb; 
            font-weight: bold; 
            background-color: #bbb; 
        }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        ul { list-style-type: none; padding: 0; }
        li { margin: 5px 0; }
        a { text-decoration: none; color: #007BFF; }
        a:hover { text-decoration: underline; }
        .coin-form { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>BOT TRADING</h1>
    <div class="tabs">
        <button class="tab-button active" data-tab="analysis">Chỉ báo</button>
        <button class="tab-button" data-tab="news">Tin tức</button>
        <button class="tab-button" data-tab="customize">Tùy chỉnh Coin</button>
    </div>

    <!-- Tab Chỉ báo (Phân tích) -->
    <div id="analysis-tab" class="tab-content active">
        <h2>Phân tích Crypto</h2>
        <p>Cập nhật lần cuối: {{ last_updated }}</p>
        {% for result in analysis_results %}
            <pre>{{ result }}</pre>
        {% endfor %}
        {% for symbol, status in BREAKOUT_STATUS.items() %}
            {% if status.message %}
                <p style="color: red;">{{ status.message }}</p>
            {% endif %}
        {% endfor %}
        <button onclick="fetch('/analyze').then(() => location.reload())">Làm mới phân tích</button>
    </div>

    <!-- Tab Tin tức -->
    <div id="news-tab" class="tab-content">
        <h2>Tin tức</h2>
        <div class="sub-tabs">
            <button class="sub-tab-item active" data-sub-tab="crypto">Crypto</button>
            <button class="sub-tab-item" data-sub-tab="economics">Kinh tế</button>
            <button class="sub-tab-item" data-sub-tab="sports">Thể thao</button>
        </div>
        <div id="crypto-tab" class="sub-tab-content active"></div>
        <div id="economics-tab" class="sub-tab-content"></div>
        <div id="sports-tab" class="sub-tab-content"></div>
    </div>

    <!-- Tab Tùy chỉnh Coin -->
    <div id="customize-tab" class="tab-content">
        <h2>Tùy chỉnh Coin</h2>
        <div class="coin-form">
            <h3>Thêm Coin</h3>
            <form id="add-coin-form" onsubmit="addCoin(event)">
                <input type="text" id="symbol" name="symbol" placeholder="Symbol (e.g., BTC)" required>
                <input type="text" id="exchange" name="exchange" placeholder="Exchange (e.g., BINANCE)" required>
                <button type="submit">Thêm</button>
            </form>
            <p id="add-coin-message"></p>
        </div>
        <div class="coin-form">
            <h3>Xóa Coin</h3>
            <form id="remove-coin-form" onsubmit="removeCoin(event)">
                <input type="text" id="remove-symbol" name="symbol" placeholder="Symbol (e.g., BTCUSDT)" required>
                <button type="submit">Xóa</button>
            </form>
            <p id="remove-coin-message"></p>
        </div>
    </div>

    <script>
        // Xử lý tab chính
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(`${button.getAttribute('data-tab')}-tab`).classList.add('active');
            });
        });

        // Xử lý sub-tab trong Tin tức
        const subTabItems = document.querySelectorAll('.sub-tab-item');
        const subTabContents = document.querySelectorAll('.sub-tab-content');
        subTabItems.forEach(item => {
            item.addEventListener('click', () => {
                subTabItems.forEach(btn => btn.classList.remove('active'));
                subTabContents.forEach(content => content.classList.remove('active'));
                item.classList.add('active');
                document.getElementById(`${item.getAttribute('data-sub-tab')}-tab`).classList.add('active');
                fetchNews(item.getAttribute('data-sub-tab'), `${item.getAttribute('data-sub-tab')}-tab`);
            });
        });

        // Lấy tin tức từ API
        function fetchNews(category, tabId) {
            fetch(`/news/${category}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`Data received for ${category}:`, data); // Debug dữ liệu
                    const tabContent = document.getElementById(tabId);
                    tabContent.innerHTML = '';
                    if (!data || data.length === 0) {
                        tabContent.innerHTML = '<p>Chưa có tin tức để hiển thị.</p>';
                    } else {
                        const ul = document.createElement('ul');
                        data.forEach(article => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${article.url}" target="_blank">${article.title}</a>`;
                            ul.appendChild(li);
                        });
                        tabContent.appendChild(ul);
                    }
                })
                .catch(error => {
                    console.error('Error fetching news:', error);
                    document.getElementById(tabId).innerHTML = '<p>Lỗi khi tải tin tức.</p>';
                });
        }

        // Thêm coin
        function addCoin(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('add-coin-form'));
            fetch('/add_coin', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('add-coin-message').textContent = data.message;
                if (data.status === 'success') {
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                console.error('Error adding coin:', error);
                document.getElementById('add-coin-message').textContent = 'Lỗi khi thêm coin.';
            });
        }

        // Xóa coin
        function removeCoin(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('remove-coin-form'));
            fetch('/remove_coin', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('remove-coin-message').textContent = data.message;
                if (data.status === 'success') {
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                console.error('Error removing coin:', error);
                document.getElementById('remove-coin-message').textContent = 'Lỗi khi xóa coin.';
            });
        }

        // Gọi khi tải trang
        document.addEventListener('DOMContentLoaded', () => {
            fetchNews('crypto', 'crypto-tab');
            fetchNews('economics', 'economics-tab');
            fetchNews('sports', 'sports-tab');
        });
    </script>
</body>
</html>